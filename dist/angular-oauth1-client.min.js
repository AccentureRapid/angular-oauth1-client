/*! angular-oauth1-client - v0.1.0 - 2015-06-16
* Copyright (c) 2015 Sean Fisher; Licensed MIT */
angular.module("oauth1Client",[]).factory("oauth1Signer",[function(){function a(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b}return{create:function(b){return _.extend({token:null,tokenSecret:"",version:"1.0",signatureMethod:"HMAC-SHA1",method:"GET",timestamp:Math.floor(Date.now()/1e3),nonce:a(32),callbackUrl:null,verifier:null,oauthParameters:function(){var a,b;return a=this,b={oauth_consumer_key:a.consumerKey,oauth_nonce:a.nonce,oauth_timestamp:a.timestamp,oauth_signature_method:a.signatureMethod},a.token&&(b.oauth_token=a.token),a.version&&(b.oauth_version=a.version),a.callbackUrl&&(b.oauth_callback=a.callbackUrl),a.verifier&&(b.oauth_verifier=a.verifier),b},queryStringFields:function(){var a,b,c;return a=this,b=a.oauthParameters(),c=a.fields,_.each(_.keys(c),function(a){return b[a]=c[a]}),b},queryString:function(){var a,b,c;a=this,b=a.queryStringFields(),c=_.keys(b).sort();var d=_.map(c,function(c){return c+"="+a.percentEncode(b[c])}).join("&");return d},urlEncoded:function(a){return _.map(_.keys(a),function(b){return b+"="+encodeURIComponent(a[b])}).join("&")},headerEncoded:function(a){return _.map(_.keys(a),function(b){return b+'="'+encodeURIComponent(a[b])+'"'}).join(", ")},urlEncodedFields:function(){var a;return a=this,a.urlEncoded(a.fields)},authorizationHeader:function(){var a,b;return a=this,b=a.oauthParameters(),b.oauth_signature=a.base64Signature(),a.headerEncoded(b)},urlAndFields:function(){var a,b;return a=this,b=a.urlEncodedFields(),b?a.url+"?"+b:a.url},parameterEncoded:function(a){var b=this;return _.map(a,function(a){return b.percentEncode(a)}).join("&")},baseString:function(){var a;return a=this,a.parameterEncoded([a.method,a.url,a.queryString()])},hmacKey:function(){var a;return a=this,a.parameterEncoded([a.consumerSecret,a.tokenSecret])},hmac:function(a){var b,c;if(b=a&&a.hasOwnProperty("encoding")&&void 0!==a.encoding?a.encoding:"binary",c=this,"undefined"!=typeof process){var d,e;return d=require("crypto"),e=d.createHmac("sha1",c.hmacKey()),e.update(c.baseString()),e.digest(b)}var f;return f=CryptoJS.HmacSHA1(c.baseString(),c.hmacKey()),"base64"===b?f.toString(CryptoJS.enc.Base64):f},base64Signature:function(){var a;return a=this,a.hmac({encoding:"base64"})},signature:function(){var a;return a=this,a.percentEncode(a.base64Signature())},signedUrl:function(){var a;return a=this,a.url+"?"+a.queryString()+"&oauth_signature="+a.signature()},curl:function(){var a;return a=this,"GET"===a.method()?"curl '"+a.url+"?"+a.queryString()+"&oauth_signature="+a.signature()+"'":"POST"===a.method()||"PUT"===a.method()?a.body()?"curl -X "+a.method()+" '"+a.urlAndFields()+"' -d '"+a.body()+"' -H 'Authorization: "+a.authorizationHeader()+"' -H 'Content-Type: "+a.bodyEncoding()+"'":"curl -X "+a.method()+" '"+a.url+"' -d '"+a.queryString()+"&oauth_signature="+a.signature()+"'":"curl -X DELETE '"+a.url+"?"+a.queryString()+"&oauth_signature="+a.signature()+"'"},percentEncode:function(a){return encodeURIComponent(a).replace(/\*/g,"%2A")}},b)}}}]).provider("oauth1Client",function(){function a(a,b){return decodeURIComponent((new RegExp("[?|&]?"+b+"=([^&;]+?)(&|#|;|$)").exec(a)||[,""])[1].replace(/\+/g,"%20"))||null}var b,c,d,e,f,g;this.config=function(a){b=a.consumerKey,c=a.consumerSecret,d=a.requestEndpoint,e=a.authorizeEndpoint,f=a.accessEndpoint,g=a.oauthCallback},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0==this.indexOf(a)}),this.$get=["$q","$http","oauth1Signer","oauth1AuthorizedHttp","localStorageService",function(h,i,j,k,l){function m(a){return j.create(a)}function n(b,c){var d=h.defer();return i.get(b.signedUrl()).success(function(b,c,e,f){d.resolve({oauth_token:a(b,"oauth_token"),oauth_token_secret:a(b,"oauth_token_secret"),oauth_callback_confirmed:a(b,"oauth_callback_confirmed")})}).error(function(a,b,c,e){d.reject("Error: "+a)}),d.promise}function o(b,c){var d=h.defer(),f=window.open(e+"?oauth_token="+b+"&oauth_callback="+c,"_blank","location=no");return f.addEventListener("loadstart",function(b){b.url.startsWith(c)&&(f.close(),d.resolve({returned_oauth_token:a(b.url,"oauth_token"),oauth_verifier:a(b.url,"verifier"),wp_scope:a(b.url,"wp_scope")}))}),d.promise}function p(b){var c=h.defer();return i.post(b.signedUrl()).success(function(b,d,e,f){c.resolve({oauth_token:a(b,"oauth_token"),oauth_token_secret:a(b,"oauth_token_secret")})}).error(function(a,b,c,d){alert("Error: "+a)}),c.promise}function q(){return l.get(t)&&l.get(u)}function r(a){l.set(t,a.oauth_token),l.set(u,a.oauth_token_secret)}function s(){var a=l.get(t),e=l.get(u),f=m({url:d,consumerKey:b,consumerSecret:c,token:a,tokenSecret:e});return k.create(f)}var t="oauth_token",u="oauth_token_secret";return{authorize:function(){var a=h.defer();if(q())a.resolve(s());else{var e=m({url:d,consumerKey:b,consumerSecret:c,callback:g});n(e,g).then(function(a){return o(a.oauth_token,g)}).then(function(a){return e=m({url:f,consumerKey:b,token:a.returned_oauth_token,callback:g,verifier:a.oauth_verifier}),p(e)}).then(function(b){r(b),a.resolve(s())})}return a.promise}}}]}).service("oauth1AuthorizedHttp",["$http",function(a){return{create:function(b){this.oauth1Signer=b;var c=this;return function(b){return c.oauth1Signer.method=b.method||"GET",c.oauth1Signer.url=b.url,a.defaults.headers.common.Authorization="OAuth "+c.oauth1Signer.authorizationHeader(),a.defaults.headers.common["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8",a(b)}}}}]);