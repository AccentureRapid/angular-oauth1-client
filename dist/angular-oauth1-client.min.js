angular.module("oauth1Client",[]).factory("oauth1Signer",[function(){function e(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;e>n;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}return{create:function(t){return _.extend({token:null,tokenSecret:"",version:"1.0",signatureMethod:"HMAC-SHA1",method:"GET",timestamp:Math.floor(Date.now()/1e3),nonce:e(32),callbackUrl:null,verifier:null,oauthParameters:function(){var e,t;return e=this,t={oauth_consumer_key:e.consumerKey,oauth_nonce:e.nonce,oauth_timestamp:e.timestamp,oauth_signature_method:e.signatureMethod},e.token&&(t.oauth_token=e.token),e.version&&(t.oauth_version=e.version),e.callbackUrl&&(t.oauth_callback=e.callbackUrl),e.verifier&&(t.oauth_verifier=e.verifier),t},queryStringFields:function(){var e,t,r;return e=this,t=e.oauthParameters(),r=e.fields,_.each(_.keys(r),function(e){return t[e]=r[e]}),t},queryString:function(){var e,t,r;e=this,t=e.queryStringFields(),r=_.keys(t).sort();var n=_.map(r,function(r){return r+"="+e.percentEncode(t[r])}).join("&");return n},urlEncoded:function(e){return _.map(_.keys(e),function(t){return t+"="+encodeURIComponent(e[t])}).join("&")},headerEncoded:function(e){return _.map(_.keys(e),function(t){return t+'="'+encodeURIComponent(e[t])+'"'}).join(", ")},urlEncodedFields:function(){var e;return e=this,e.urlEncoded(e.fields)},authorizationHeader:function(){var e,t;return e=this,t=e.oauthParameters(),t.oauth_signature=e.base64Signature(),e.headerEncoded(t)},urlAndFields:function(){var e,t;return e=this,t=e.urlEncodedFields(),t?e.url+"?"+t:e.url},parameterEncoded:function(e){var t=this;return _.map(e,function(e){return t.percentEncode(e)}).join("&")},baseString:function(){var e;return e=this,e.parameterEncoded([e.method,e.url,e.queryString()])},hmacKey:function(){var e;return e=this,e.parameterEncoded([e.consumerSecret,e.tokenSecret])},hmac:function(e){var t,r;if(t=e&&e.hasOwnProperty("encoding")&&void 0!==e.encoding?e.encoding:"binary",r=this,"undefined"!=typeof process){var n,o;return n=require("crypto"),o=n.createHmac("sha1",r.hmacKey()),o.update(r.baseString()),o.digest(t)}var u;return u=CryptoJS.HmacSHA1(r.baseString(),r.hmacKey()),"base64"===t?u.toString(CryptoJS.enc.Base64):u},base64Signature:function(){var e;return e=this,e.hmac({encoding:"base64"})},signature:function(){var e;return e=this,e.percentEncode(e.base64Signature())},signedUrl:function(){var e;return e=this,e.url+"?"+e.queryString()+"&oauth_signature="+e.signature()},curl:function(){var e;return e=this,"GET"===e.method()?"curl '"+e.url+"?"+e.queryString()+"&oauth_signature="+e.signature()+"'":"POST"===e.method()||"PUT"===e.method()?e.body()?"curl -X "+e.method()+" '"+e.urlAndFields()+"' -d '"+e.body()+"' -H 'Authorization: "+e.authorizationHeader()+"' -H 'Content-Type: "+e.bodyEncoding()+"'":"curl -X "+e.method()+" '"+e.url+"' -d '"+e.queryString()+"&oauth_signature="+e.signature()+"'":"curl -X DELETE '"+e.url+"?"+e.queryString()+"&oauth_signature="+e.signature()+"'"},percentEncode:function(e){return encodeURIComponent(e).replace(/\*/g,"%2A")}},t)}}}]).provider("oauth1Client",function(){function e(e,t){return decodeURIComponent((new RegExp("[?|&]?"+t+"=([^&;]+?)(&|#|;|$)").exec(e)||[,""])[1].replace(/\+/g,"%20"))||null}var t,r,n,o,u,a;this.config=function(e){t=e.consumerKey,r=e.consumerSecret,n=e.requestEndpoint,o=e.authorizeEndpoint,u=e.accessEndpoint,a=e.oauthCallback},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return 0==this.indexOf(e)}),this.$get=["$q","$http","oauth1Signer","oauth1AuthorizedHttp","localStorageService",function(i,c,s,h,d){function l(e){return s.create(e)}function f(t){var r=i.defer();return c.get(t.signedUrl()).success(function(t){r.resolve({oauth_token:e(t,"oauth_token"),oauth_token_secret:e(t,"oauth_token_secret"),oauth_callback_confirmed:e(t,"oauth_callback_confirmed")})}).error(function(e){r.reject("Error: "+e)}),r.promise}function m(t,r){var n=i.defer(),u=window.open(o+"?oauth_token="+t+"&oauth_callback="+r,"_blank","location=no");return u.addEventListener("loadstart",function(t){t.url.startsWith(r)&&(u.close(),n.resolve({returned_oauth_token:e(t.url,"oauth_token"),oauth_verifier:e(t.url,"verifier"),wp_scope:e(t.url,"wp_scope")}))}),n.promise}function _(t){var r=i.defer();return c.post(t.signedUrl()).success(function(t){r.resolve({oauth_token:e(t,"oauth_token"),oauth_token_secret:e(t,"oauth_token_secret")})}).error(function(e){alert("Error: "+e)}),r.promise}function g(){return d.get(k)&&d.get(S)}function p(e){d.set(k,e.oauth_token),d.set(S,e.oauth_token_secret)}function v(){var e=d.get(k),o=d.get(S),u=l({url:n,consumerKey:t,consumerSecret:r,token:e,tokenSecret:o});return h.create(u)}var k="oauth_token",S="oauth_token_secret";return{authorize:function(){var e=i.defer();if(g())e.resolve(v());else{var o=l({url:n,consumerKey:t,consumerSecret:r,callback:a});f(o,a).then(function(e){return m(e.oauth_token,a)}).then(function(e){return o=l({url:u,consumerKey:t,token:e.returned_oauth_token,callback:a,verifier:e.oauth_verifier}),_(o)}).then(function(t){p(t),e.resolve(v())})}return e.promise}}}]}).service("oauth1AuthorizedHttp",["$http",function(e){return{create:function(t){this.oauth1Signer=t;var r=this;return function(t){return r.oauth1Signer.method=t.method||"GET",r.oauth1Signer.url=t.url,e.defaults.headers.common.Authorization="OAuth "+r.oauth1Signer.authorizationHeader(),e.defaults.headers.common["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8",e(t)}}}}]);
